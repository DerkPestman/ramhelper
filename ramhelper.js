javascript:(function(){if(window.__RamHelper__){window.__RamHelper__.open();return;}var s=document.createElement('script');s.src='data:text/javascript;charset=utf-8,'+encodeURIComponent(`(()=>{const APP_VER='1.0.0';const LS_KEY='RH_barbWalls';const CFG_KEY='RH_cfg';const htmlEscape=s=>s.replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));function getParam(u,k){const m=(u||location.href).match(new RegExp('[?&]'+k+'=(\\d+)'));return m?m[1]:null;}function getVillageCoordFromDOM(){const t=document.body.innerText||'';const m=t.match(/\\b(\\d{3})\\|(\\d{3})\\b/);if(m)return{ x:+m[1],y:+m[2]};return null;}function dist(a,b){const dx=a.x-b.x,dy=a.y-b.y;return Math.sqrt(dx*dx+dy*dy);}function loadMap(){try{return JSON.parse(localStorage.getItem(LS_KEY)||'{}');}catch(e){return{};}}function saveMap(map){localStorage.setItem(LS_KEY,JSON.stringify(map));}function loadCfg(){const d={radius:30,minWall:1,maxWall:20,safeRams:[0,2,3,4,6,8,10,12,14,16,18,20,22],forceSpy:1,sort:'dist_then_wall',};try{return Object.assign(d,JSON.parse(localStorage.getItem(CFG_KEY)||'{}'));}catch(e){return d;}}function saveCfg(cfg){localStorage.setItem(CFG_KEY,JSON.stringify(cfg));}function wallToRams(w,cfg){const arr=cfg.safeRams;const idx=Math.max(0,Math.min(arr.length-1,w));return arr[idx]||arr[arr.length-1];}function ensureFrame(){let box=document.getElementById('rh-box');if(box)return box;box=document.createElement('div');box.id='rh-box';box.style.position='fixed';box.style.top='64px';box.style.right='24px';box.style.zIndex=2147483647;box.style.width='560px';box.style.maxHeight='70vh';box.style.overflow='auto';box.style.background='#2b2116';box.style.color='#f0e6d2';box.style.border='1px solid #7b5e3b';box.style.borderRadius='10px';box.style.boxShadow='0 8px 20px rgba(0,0,0,.45)';box.style.font='14px/1.4 Arial, sans-serif';box.innerHTML='<div id="rh-head" style="display:flex;align-items:center;justify-content:space-between;padding:8px 12px;background:#3a2d1f;border-bottom:1px solid #7b5e3b;border-top-left-radius:10px;border-top-right-radius:10px;cursor:move;"><div><b>RamHelper</b> <span style="opacity:.7">v'+APP_VER+'</span></div><div><button id="rh-close" style="background:#7b5e3b;border:none;color:#fff;padding:4px 8px;border-radius:6px;cursor:pointer">X</button></div></div><div id="rh-body" style="padding:10px 12px"></div>';document.body.appendChild(box);(function drag(){const head=box.querySelector('#rh-head');let ox=0,oy=0,down=false;head.addEventListener('mousedown',e=>{down=true;ox=e.clientX-box.offsetLeft;oy=e.clientY-box.offsetTop;});document.addEventListener('mousemove',e=>{if(!down)return;box.style.left=(e.clientX-ox)+'px';box.style.top=(e.clientY-oy)+'px';box.style.right='auto';});document.addEventListener('mouseup',()=>down=false);})();box.querySelector('#rh-close').onclick=()=>box.remove();return box;}function render(){const box=ensureFrame();const body=box.querySelector('#rh-body');const cfg=loadCfg();const map=loadMap();const currentVid=getParam(location.href,'village');const vCoord=getVillageCoordFromDOM();const keys=Object.keys(map);let rows=[];let info='';if(!vCoord){info='<div style="margin:6px 0 10px;color:#ffcc88">Kon je dorpscoördinaten niet zeker vinden op deze pagina. Stel ze hieronder in of open het aanvalsscherm van je huidige dorp.</div>';}const headerControls='<div style="display:grid;grid-template-columns:repeat(6,1fr);gap:6px;margin-bottom:8px;"><label>Radius<br><input id="rh-radius" type="number" min="1" max="100" value="'+cfg.radius+'" style="width:100%"></label><label>Min muur<br><input id="rh-minwall" type="number" min="0" max="20" value="'+cfg.minWall+'" style="width:100%"></label><label>Sortering<br><select id="rh-sort" style="width:100%"><option value="dist_then_wall"'+(cfg.sort==='dist_then_wall'?' selected':'')+'>Afstand → Muur</option><option value="wall_then_dist"'+(cfg.sort==='wall_then_dist'?' selected':'')+'>Muur → Afstand</option></select></label><label>Force scout<br><input id="rh-spy" type="number" min="0" max="5" value="'+cfg.forceSpy+'" style="width:100%"></label><label>Mijn coords<br><input id="rh-mycoords" placeholder="xxx|yyy" value="'+(vCoord? (vCoord.x+'|'+vCoord.y):'')+'" style="width:100%"></label><div style="display:flex;gap:6px;align-items:flex-end;"><button id="rh-save" style="flex:1;background:#6a8e3a;border:none;color:#fff;padding:6px;border-radius:6px;cursor:pointer;">Opslaan</button><button id="rh-scan" style="flex:1;background:#3a6a8e;border:none;color:#fff;padding:6px;border-radius:6px;cursor:pointer;" title="Scan huidige rapportlijst of geopende rapportpagina">Scan</button></div></div>';if(keys.length===0){body.innerHTML=info+headerControls+'<div style="opacity:.7">Nog geen barbs met muurdata. Open je [Rapporten] (verkenningsrapporten) en klik <b>Scan</b>.</div>';hook();return;}let my=vCoord;if(!my){const s=(document.getElementById('rh-mycoords')||{}).value||'';const m=s.match(/(\\d{3})\\|(\\d{3})/);if(m)my={x:+m[1],y:+m[2]};}const list=[];keys.forEach(k=>{const e=map[k];if(!e||typeof e.wall!=='number')return;const xy=k.split('|');const barb={id:e.id||null,x:+xy[0],y:+xy[1],wall:e.wall,ts:e.ts||0};barb.dist=my? +dist(my,barb).toFixed(1):null;list.push(barb);});const filtered=list.filter(b=>{if(my && cfg.radius && b.dist!=null && b.dist>cfg.radius)return false;return b.wall>=cfg.minWall && b.wall<=cfg.maxWall;});filtered.sort((a,b)=>{if(cfg.sort==='wall_then_dist'){if(b.wall!==a.wall)return b.wall-a.wall;return (a.dist??999)-(b.dist??999);}else{if((a.dist??999)!==(b.dist??999))return (a.dist??999)-(b.dist??999);return b.wall-a.wall;}});const headRow='<div style="display:grid;grid-template-columns:84px 72px 72px 1fr 120px 112px;gap:6px;padding:6px 8px;border-bottom:1px solid #5b452d;background:#342817;color:#e8dcbf;font-weight:bold;"><div>Coords</div><div>Muur</div><div>Afst.</div><div>Advies</div><div>Actie</div><div>Beheer</div></div>';rows.push(headRow);filtered.forEach(b=>{const rams=wallToRams(b.wall,cfg);const spy=Math.max(0,~~cfg.forceSpy);const coords=b.x+'|'+b.y;const targetParam=b.id?('target='+b.id):('x='+b.x+'&y='+b.y);const base='game.php?village='+(currentVid||'')+'&screen=place&'+targetParam+'&ram='+rams+(spy?('&spy='+spy):'');rows.push('<div style="display:grid;grid-template-columns:84px 72px 72px 1fr 120px 112px;gap:6px;align-items:center;padding:6px 8px;border-bottom:1px dashed #5b452d;"><div>['+coords+']</div><div>Lv '+b.wall+'</div><div>'+(b.dist!=null?b.dist:'?')+'</div><div>'+rams+' rammen + '+(spy||0)+' scout</div><div><a href="'+base+'" target="_blank" style="background:#7b5e3b;color:#fff;text-decoration:none;padding:4px 8px;border-radius:6px;display:inline-block;">Open place</a></div><div><button data-rh="markdown" data-k="'+coords+'" style="background:#54402a;border:none;color:#ffd89a;padding:4px 8px;border-radius:6px;cursor:pointer;">Muur weg</button> <button data-rh="rescout" data-k="'+coords+'" style="background:#3a6a8e;border:none;color:#fff;padding:4px 8px;border-radius:6px;cursor:pointer;">Rescout</button></div></div>');});const emptyNote=(filtered.length? '' : '<div style="padding:10px 4px;color:#ffcc88">Binnen de ingestelde radius zijn geen barbs met muren (>= min muur). Pas je radius of min muur aan.</div>');const legend='<details style="margin-top:8px;"><summary style="cursor:pointer">Instellingen & uitleg</summary><div style="padding:8px 2px;opacity:.9">• <b>Scan</b> werkt op de huidige <i>Rapporten</i>-lijstpagina of openstaand verkenningsrapport (haalt coords, village-id en muurlevel op).<br>• <b>Muur weg</b> verwijdert het doel uit je lijst (of zet muur=0).<br>• <b>Open place</b> opent het aanvalsscherm met ingevulde rammen/scout; jij bevestigt handmatig.<br>• <b>Rammen-regel</b> is royaal: safeRams[wall]; pas aan in geavanceerd menu.</div></details>';const advBtn='<details style="margin-top:8px;"><summary style="cursor:pointer">Geavanceerd: rammen per muurlevel</summary><div style="padding:8px 2px"><div>Array-index = muurlevel; waarde = rammen. Voorbeeld (0..12): [0,2,3,4,6,8,10,12,14,16,18,20,22]</div><textarea id="rh-ramrule" style="width:100%;height:80px;background:#1f1710;color:#e8dcbf;border:1px solid #5b452d;border-radius:6px;">'+JSON.stringify(loadCfg().safeRams)+'</textarea><div style="margin-top:6px;display:flex;gap:6px;"><button id="rh-ramrule-save" style="background:#6a8e3a;border:none;color:#fff;padding:6px 10px;border-radius:6px;cursor:pointer;">Opslaan rammenregel</button><button id="rh-clear" style="background:#8e3a3a;border:none;color:#fff;padding:6px 10px;border-radius:6px;cursor:pointer;">Alles wissen</button></div></div></details>';body.innerHTML=info+headerControls+emptyNote+rows.join('')+legend+advBtn;hook();function hook(){document.getElementById('rh-save').onclick=()=>{const cfg=loadCfg();cfg.radius=+document.getElementById('rh-radius').value||cfg.radius;cfg.minWall=+document.getElementById('rh-minwall').value||cfg.minWall;cfg.sort=document.getElementById('rh-sort').value;cfg.forceSpy=+document.getElementById('rh-spy').value||0;const mc=(document.getElementById('rh-mycoords').value||'').match(/(\\d{3})\\|(\\d{3})/);if(mc){cfg.my={x:+mc[1],y:+mc[2]};}saveCfg(cfg);render();};document.getElementById('rh-scan').onclick=scanCurrent;const ta=document.getElementById('rh-ramrule');const saveBtn=document.getElementById('rh-ramrule-save');saveBtn.onclick=()=>{try{const arr=JSON.parse(ta.value);if(!Array.isArray(arr)||arr.some(v=>typeof v!=='number'))throw 0;const cfg=loadCfg();cfg.safeRams=arr;saveCfg(cfg);alert('Rammenregel opgeslagen.');render();}catch(e){alert('Ongeldige array. Voorbeeld: [0,2,3,4,6,8,10,12,14,16,18,20,22]');}};document.getElementById('rh-clear').onclick=()=>{if(confirm('Alle opgeslagen barb-muurdata wissen?')){saveMap({});render();}};body.querySelectorAll('button[data-rh="markdown"]').forEach(b=>b.onclick=()=>{const k=b.getAttribute('data-k');const map=loadMap();if(map[k]){map[k].wall=0;}saveMap(map);render();});body.querySelectorAll('button[data-rh="rescout"]').forEach(b=>b.onclick=()=>{alert('Open het verkenningsrapport van ['+b.getAttribute('data-k')+'] en klik in deze tool op Scan om te updaten.');});}}function parseWallFromReportHtml(html){const doc=new DOMParser().parseFromString(html,'text/html');let wall=undefined,coords=undefined,id=undefined;const txt=doc.body.innerText||'';const mWall=txt.match(/Muur\\s*:\\s*niveau\\s*(\\d+)|Wall\\s*:\\s*Level\\s*(\\d+)/i);if(mWall)wall=+((mWall[1]||mWall[2]));const mCoord=txt.match(/\\b(\\d{3})\\|(\\d{3})\\b/);if(mCoord)coords=mCoord[1]+'|'+mCoord[2];const villLink=doc.querySelector('a[href*="screen=info_village"][href*="id="]');if(villLink){const m=villLink.href.match(/id=(\\d+)/);if(m)id=m[1];}return{wall,coords,id};}async function scanCurrent(){try{const url=new URL(location.href);if(url.searchParams.get('screen')==='report'){const isSingle=!!url.searchParams.get('view');if(isSingle){const res=await fetch(location.href,{credentials:'same-origin'});const html=await res.text();const got=parseWallFromReportHtml(html);if(!got.coords||typeof got.wall!=='number'){alert('Kon geen muur of coords vinden op dit rapport.');return;}const map=loadMap();map[got.coords]={wall:got.wall,id:got.id|| (map[got.coords]?map[got.coords].id:null),ts:Date.now()};saveMap(map);alert('Opgeslagen: ['+got.coords+'] muur '+got.wall);render();}else{const rows=[...document.querySelectorAll('a[href*="screen=report"][href*="view="]')].slice(0,50);if(!rows.length){alert('Geen rapportlinks gevonden op deze pagina.');return;}let count=0;for(const a of rows){try{const r=await fetch(a.href,{credentials:'same-origin'});const html=await r.text();const got=parseWallFromReportHtml(html);if(got.coords && typeof got.wall==='number'){const map=loadMap();map[got.coords]={wall:got.wall,id:got.id|| (map[got.coords]?map[got.coords].id:null),ts:Date.now()};saveMap(map);count++;}}catch(e){} }alert('Scan klaar. Geüpdatet: '+count+' rapport(en).');render();}}else{alert('Open Rapporten (verkenning) of een specifiek rapport en klik opnieuw op Scan.');}}catch(e){alert('Scan fout: '+(e&&e.message?e.message:e));}};window.__RamHelper__={open:render};render();})();`);document.body.appendChild(s);})()
